version: '3.8'

services:
  # ===================================================================================
  # DỊCH VỤ SQL SERVER (Dùng cho cả Airflow Metadata và DWH)
  # ===================================================================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: careerbi_dwh_sqlserver
    env_file:
      - .env
    volumes:
      - sqlserver-data:/var/opt/mssql
    ports:
      - "1433:1433"
    healthcheck:
      # Kiểm tra xem 'sa' có thể đăng nhập được chưa
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "${MSSQL_SA_PASSWORD}", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # ===================================================================================
  # DỊCH VỤ AIRFLOW (Đã cấu hình để chạy với MSSQL)
  # ===================================================================================
  
  airflow-init:
    build: .  # Dùng Dockerfile để cài driver
    container_name: airflow_init
    env_file:
      - .env
    # Thêm biến môi trường để Airflow biết kết nối tới đâu
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=mssql+pyodbc://sa:${MSSQL_SA_PASSWORD}@sqlserver:1433/${AIRFLOW_METADATA_DB}?driver=ODBC+Driver+17+for+SQL+Server
    depends_on:
      sqlserver:
        condition: service_healthy # Chờ SQL Server sẵn sàng
    entrypoint: /bin/bash
    command:
      - -c
      - |
        echo "Đang chờ SQL Server (tối đa 30s)..."
        # Chờ 10s cho SQL Server ổn định
        sleep 10
        
        echo "Tạo DB metadata '${AIRFLOW_METADATA_DB}' nếu chưa có..."
        /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P ${MSSQL_SA_PASSWORD} -d master -Q "IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'${AIRFLOW_METADATA_DB}') CREATE DATABASE ${AIRFLOW_METADATA_DB}"
        
        echo "Khởi tạo Airflow DB..."
        airflow db init

        echo "Tạo tài khoản Admin..."
        airflow users create \
          --username ${_AIRFLOW_WWW_USER_USERNAME} \
          --password ${_AIRFLOW_WWW_USER_PASSWORD} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com
    restart: on-failure

  airflow-webserver:
    build: .  # Dùng Dockerfile
    container_name: airflow_webserver
    env_file:
      - .env
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=mssql+pyodbc://sa:${MSSQL_SA_PASSWORD}@sqlserver:1433/${AIRFLOW_METADATA_DB}?driver=ODBC+Driver+17+for+SQL+Server
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    volumes:
      - ./scrape_job:/opt/airflow/scrape_job
      - ./data:/opt/airflow/data
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
    ports:
      - "8080:8080"
    command: webserver
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 10s
      timeout: 10s
      retries: 3
    restart: always

  airflow-scheduler:
    build: .  # Dùng Dockerfile
    container_name: airflow_scheduler
    env_file:
      - .env
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=mssql+pyodbc://sa:${MSSQL_SA_PASSWORD}@sqlserver:1433/${AIRFLOW_METADATA_DB}?driver=ODBC+Driver+17+for+SQL+Server
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    volumes:
      - ./scrape_job:/opt/airflow/scrape_job
      - ./data:/opt/airflow/data
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
    command: scheduler
    restart: always

# ===================================================================================
# ĐỊNH NGHĨA VOLUMES (Nơi lưu trữ dữ liệu)
# ===================================================================================
volumes:
  sqlserver-data: # Chỉ còn volume của SQL Server