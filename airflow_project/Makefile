# Makefile for the CareerBI Airflow Project

.PHONY: all up down start stop restart ui db-dwh db-meta logs help

all: up

up:
	@echo "üöÄ Starting Airflow (Webserver, Scheduler) and SQL Server..."
	@echo "L·∫ßn ƒë·∫ßu ch·∫°y s·∫Ω m·∫•t th·ªùi gian ƒë·ªÉ build image (c√†i driver MSSQL)..."
	docker-compose up -d --build

down:
	@echo "üõë Stopping and removing all services..."
	docker-compose down

start: up
stop: down
restart: down up

ui:
	@echo "Opening Airflow UI at http://localhost:8080..."
	@if [ "$(shell uname)" = "Darwin" ]; then \
		open http://localhost:8080; \
	else \
		xdg-open http://localhost:8080; \
	fi

# Truy c·∫≠p DB DWH (careerbi)
db-dwh:
	@echo "Connecting to SQL Server DWH (database: careerbi)..."
	@echo "G√µ 'exit' ƒë·ªÉ tho√°t."
	docker-compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -d careerbi -P ${MSSQL_SA_PASSWORD}

# Truy c·∫≠p DB Metadata (airflow_meta)
db-meta:
	@echo "Connecting to SQL Server Metadata (database: airflow_meta)..."
	@echo "G√µ 'exit' ƒë·ªÉ tho√°t."
	docker-compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -d ${AIRFLOW_METADATA_DB} -P ${MSSQL_SA_PASSWORD}

logs:
	@echo "Tailing logs for all services (Press Ctrl+C to exit)..."
	docker-compose logs -f --tail=100

help:
	@echo "Available commands for CareerBI project:"
	@echo "------------------------------------------------"
	@echo "  make up        : Kh·ªüi ƒë·ªông t·∫•t c·∫£ d·ªãch v·ª• (build image n·∫øu c·∫ßn)."
	@echo "  make down      : D·ª´ng v√† g·ª° b·ªè t·∫•t c·∫£ d·ªãch v·ª•."
	@echo "  make restart   : Kh·ªüi ƒë·ªông l·∫°i t·∫•t c·∫£ d·ªãch v·ª•."
	@echo "  make ui        : M·ªü giao di·ªán Web Airflow (localhost:8080)."
	@echo "  make db-dwh    : Truy c·∫≠p v√†o DB Data Warehouse (careerbi)."
	@echo "  make db-meta   : Truy c·∫≠p v√†o DB Metadata c·ªßa Airflow (airflow_meta)."
	@echo "  make logs      : Xem log c·ªßa c√°c d·ªãch v·ª• ƒëang ch·∫°y."