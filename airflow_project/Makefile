# Makefile for the CareerBI Airflow Project

# Target m·∫∑c ƒë·ªãnh, ch·∫°y khi b·∫°n ch·ªâ g√µ "make"
.PHONY: all up down start stop restart ui db logs help clean-logs full-reset
all: up

# Kh·ªüi ƒë·ªông t·∫•t c·∫£ d·ªãch v·ª• (·ªü ch·∫ø ƒë·ªô n·ªÅn)
# (Th√™m --build ƒë·ªÉ n√≥ x√¢y d·ª±ng Dockerfile, c√†i scrapy/pandas)
up:
	@echo "üöÄ Starting Airflow (Webserver, Scheduler) and Postgres..."
	@echo "Building custom image with scrapy/pandas/sqlalchemy..."
	docker-compose up -d --build

# D·ª´ng v√† g·ª° b·ªè t·∫•t c·∫£ container
down:
	@echo "üõë Stopping and removing all Airflow containers..."
	docker-compose down

# 'start' v√† 'stop' l√† c√°c t√™n g·ªçi kh√°c (alias) cho ti·ªán
start: up
stop: down

# Kh·ªüi ƒë·ªông l·∫°i to√†n b·ªô d·ªãch v·ª•
restart: down up

# M·ªü giao di·ªán Web Airflow
ui:
	@echo "Opening Airflow UI at http://localhost:8080..."
	@echo "N·∫øu tr√¨nh duy·ªát kh√¥ng t·ª± m·ªü, h√£y truy c·∫≠p: http://localhost:8080"
	@if [ "$(shell uname)" = "Darwin" ]; then \
		open http://localhost:8080; \
	else \
		xdg-open http://localhost:8080; \
	fi

# Truy c·∫≠p v√†o shell psql c·ªßa database 'careerbi'
db:
	@echo "Connecting to PostgreSQL database 'careerbi' as user 'careerbi_user'..."
	@echo "G√µ '\\q' ƒë·ªÉ tho√°t."
	docker-compose exec postgres psql -U careerbi_user -d careerbi

# Xem log c·ªßa t·∫•t c·∫£ c√°c service
logs:
	@echo "Tailing logs for all services (Press Ctrl+C to exit)..."
	docker-compose logs -f --tail=100

# ===================================================================================
# L·ªÜNH D·ªåN D·∫∏P (N√ÇNG CAO)
# ===================================================================================

# L·ªánh n√†y ch·ªâ x√≥a file log (an to√†n)
clean-logs:
	@echo "üßπ Cleaning up log files..."
	@echo "L∆∞u √Ω: C√≥ th·ªÉ b·∫°n c·∫ßn nh·∫≠p m·∫≠t kh·∫©u (sudo) ƒë·ªÉ x√≥a file do Docker t·∫°o"
	sudo rm -rf ./logs/*
	@echo "Done."

# L·ªánh n√†y reset TO√ÄN B·ªò (NGUY HI·ªÇM)
# N√≥ s·∫Ω x√≥a h·∫øt database, log, v√† d·ª´ng container
full-reset:
	@echo "üî• WARNING: This will delete ALL containers, logs, AND THE DATABASE. üî•"
	@read -p "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô? (y/N) " -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "Nuking all data..."; \
		docker-compose down -v; \
		sudo rm -rf ./logs/*; \
		sudo rm -rf ./data/clean/*; \
		echo "Full reset complete. B·∫°n c√≥ th·ªÉ ch·∫°y 'make up' ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu."; \
	else \
		echo "H·ªßy b·ªè."; \
	fi

# ===================================================================================

# Target tr·ª£ gi√∫p, li·ªát k√™ c√°c l·ªánh
help:
	@echo "Available commands for CareerBI project:"
	@echo "------------------------------------------------"
	@echo "  make up        : Kh·ªüi ƒë·ªông t·∫•t c·∫£ d·ªãch v·ª• (build image n·∫øu c·∫ßn)."
	@echo "  make down      : D·ª´ng v√† g·ª° b·ªè t·∫•t c·∫£ d·ªãch v·ª•."
	@echo "  make restart   : Kh·ªüi ƒë·ªông l·∫°i t·∫•t c·∫£ d·ªãch v·ª•."
	@echo "  make ui        : M·ªü giao di·ªán Web Airflow (localhost:8080)."
	@echo "  make db        : Truy c·∫≠p v√†o database 'careerbi' (Postgres)."
	@echo "  make logs      : Xem log c·ªßa c√°c d·ªãch v·ª• ƒëang ch·∫°y."
	@echo "  make clean-logs: (An to√†n) X√≥a c√°c file log trong th∆∞ m·ª•c ./logs."
	@echo "  make full-reset: (Nguy hi·ªÉm) X√≥a h·∫øt container, database v√† logs."